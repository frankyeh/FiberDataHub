name: Fetch QC TSV & Publish Release

on:
  workflow_dispatch:

jobs:
  collect-and-publish:
    runs-on: ubuntu-latest

    steps:
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y jq

    - name: Download QC TSVs (GraphQL)
      env:
        PAT_TOKEN: ${{ secrets.PAT_TOKEN }}
      shell: bash
      run: |
        set -euo pipefail
        mkdir -p qc_files
        accounts=(data-hcp data-nih data-openneuro data-indi data-others)
    
        # GraphQL requires a token
        auth=(-H "Authorization: Bearer $PAT_TOKEN")
    
        for acct in "${accounts[@]}"; do
          echo "→ Account: $acct"
          
          # 1. Fetch Repos (Unified endpoint works for Users & Orgs)
          repos=$(curl -sf "${auth[@]}" "https://api.github.com/users/$acct/repos?per_page=100" \
            | jq -r '.[].name') || continue
    
          for repo in $repos; do
            echo "  • Repo: $repo"
            cursor=null
    
            # 2. Fetch Releases via GraphQL (No 504s, fast pagination)
            while :; do
              query='query($o:String!,$r:String!,$c:String){repository(owner:$o,name:$r){releases(first:100,after:$c){pageInfo{endCursor}nodes{tagName,releaseAssets(first:5,name:"qc.tsv"){nodes{downloadUrl}}}}}}'
              json=$(jq -nc --arg o "$acct" --arg r "$repo" --arg c "$cursor" --arg q "$query" '{query:$q,variables:{o:$o,r:$r,c:$c}}')
    
              resp=$(curl -sf -X POST "${auth[@]}" -d "$json" https://api.github.com/graphql) || break
    
              # Parse & Download in one pass
              jq -r '.data.repository.releases.nodes[] | {t:.tagName, u:(.releaseAssets.nodes[0].downloadUrl)} | select(.u) | [.t,.u] | @tsv' <<<"$resp" |
              while read -r tag url; do
                out="qc_files/${acct}_${repo}_${tag}_qc.tsv"
                curl -sL "${auth[@]}" "$url" -o "$out"
                n=$(( $(wc -l < "$out") - 1 ))
                echo "      - downloading $tag (n=$n)"
              done
              wait # Wait for background downloads if '&' is used
    
              # Pagination check
              cursor=$(jq -r '.data.repository.releases.pageInfo.endCursor // empty' <<<"$resp")
              [[ -z "$cursor" ]] && break
            done
          done
        done

    - name: Remove & Re-upload QC TSVs via GH CLI
      env:
        GH_TOKEN: ${{ secrets.PAT_TOKEN }}
      run: |
        gh release delete qc-data -y --repo frankyeh/FiberDataHub || true
        gh release create qc-data ./qc_files/*.tsv --repo frankyeh/FiberDataHub
